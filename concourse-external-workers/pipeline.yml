jobs:
- name: concourse_workers
  plan:
  - aggregate:
    - get: stemcell
    - get: concourse-deployment
    - get: bucc-pipelines
  - put: credhub
    params: { schema_file: bucc-pipelines/concourse-external-workers/bosh/schema.yml }
  - put: deploy
    params:
      skip_drain: [ "true" ]
      manifest: concourse-deployment/cluster/external-worker.yml
      stemcells: [ stemcell/stemcell.tgz ]
      ops_files:
      - bucc-pipelines/concourse-external-workers/bosh/operations/absolute_concourse_creds.yml
      - bucc-pipelines/concourse-external-workers/bosh/operations/credhub_pseudo_array.yml
      vars:
        deployment_name: concourse_workers
        concourse_version: 4.2.1
        concourse_sha1: 470a6fdd7cb82fc723d7d78930c7d261ca4a6cb4
        garden_runc_version: 1.18.3
        garden_runc_sha1: 1aa15e644c6c0c6c7ec072bf668fe5d9bcc4c632

resources:
- name: concourse-deployment
  type: git
  source:
    uri: https://github.com/concourse/concourse-deployment.git
    branch: master
    tag_filter: "v4.2.1"    

- name: bucc-pipelines
  type: git
  source:
    uri: https://github.com/starkandwayne/bucc-pipelines.git

- name: stemcell
  type: bosh-io-stemcell
  source: { name: ((bosh_stemcell)) }

- name: deploy
  type: bosh-deployment
  source:
    deployment: concourse_workers
    target: ((bosh_environment))
    client: ((bosh_client))
    client_id: ((bosh_client))
    client_secret: ((bosh_client_secret))
    ca_cert: ((bosh_ca_cert))

- name: credhub
  type: credhub-schema
  source:
    server: ((credhub_url))
    client_name: ((credhub_username))
    client_secret: ((credhub_password))
    ca_cert: ((credhub_ca_cert))
    path: /((bosh_name))/concourse_workers

resource_types:
- name: bosh-deployment
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource
    tag: latest
- name: credhub-schema
  type: docker-image
  source:
    repository: rkoster/credhub-schema-resource
    tag: latest
